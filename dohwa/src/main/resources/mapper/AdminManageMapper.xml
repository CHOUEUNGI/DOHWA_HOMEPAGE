<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.dohwa.mapper.AdminManageMapper">

	<insert id="insertMsgProp" parameterType="java.util.HashMap">
		INSERT INTO TB_MSG_PROP(LANG, CODE, TEXT, DEF_TXT, MENU_LVL1, MENU_LVL2, MENU_LVL3, MENU_LVL4, MENU_LVL5, REF1, REF2, REF3, USE_YN, REG_ID, REG_DT)
		VALUES(#{LANG}, #{CODE}, #{TEXT}, #{DEF_TXT}, #{MENU_LVL1}, #{MENU_LVL2}, #{MENU_LVL3}, #{MENU_LVL4}, #{MENU_LVL5}, #{REF1}, #{REF2}, #{REF3}, #{USE_YN}, #{REG_ID}, CURRENT_TIMESTAMP)
		ON DUPLICATE KEY UPDATE TEXT = #{TEXT},
								DEF_TXT = #{DEF_TXT},
								MENU_LVL1 = #{MENU_LVL1},
								MENU_LVL2 = #{MENU_LVL2},
								MENU_LVL3 = #{MENU_LVL3},
								MENU_LVL4 = #{MENU_LVL4},
								MENU_LVL5 = #{MENU_LVL5},
								REF1 = #{REF1},
								REF2 = #{REF2},
								REF3 = #{REF3},
								USE_YN  = #{USE_YN},
								UPD_ID = #{REG_ID},
							    UPD_DT = CURRENT_TIMESTAMP
	</insert>
	
	<insert id="insertMsgPropOnlyAdd" parameterType="java.util.HashMap">
		INSERT INTO TB_MSG_PROP(LANG, CODE, TEXT, DEF_TXT, MENU_LVL1, MENU_LVL2, MENU_LVL3, MENU_LVL4, MENU_LVL5, REF1, REF2, REF3, USE_YN, REG_ID, REG_DT)
		VALUES(#{LANG}, #{CODE}, #{TEXT}, #{DEF_TXT}, #{MENU_LVL1}, #{MENU_LVL2}, #{MENU_LVL3}, #{MENU_LVL4}, #{MENU_LVL5}, #{REF1}, #{REF2}, #{REF3}, #{USE_YN}, #{REG_ID}, CURRENT_TIMESTAMP)
		ON DUPLICATE KEY UPDATE UPD_ID = #{REG_ID},
							    UPD_DT = CURRENT_TIMESTAMP
	</insert>

	<select id="getMsgPropList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			LANG
			, CODE
			, TEXT
			, DEF_TXT
			, MENU_LVL1
			, MENU_LVL2
			, MENU_LVL3
			, MENU_LVL4
			, MENU_LVL5
			, REF1
			, REF2
			, REF3
			, USE_YN
			, REG_ID
			, REG_DT
			, UPD_ID
			, UPD_DT
		FROM
			dohwa.tb_msg_prop
		WHERE
			LANG = #{LANG}
			AND USE_YN = 'Y'
		ORDER BY CODE ASC
	</select>

	<select id="getMsgPropGrpCodeList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			CODE,
			MAX(CASE WHEN LANG = 'KO' THEN IFNULL(TEXT, DEF_TXT) ELSE '' END) KO_TEXT,
			MAX(CASE WHEN LANG = 'EN' THEN IFNULL(TEXT, DEF_TXT) ELSE '' END) EN_TEXT,
			MAX(CASE WHEN LANG = 'ES' THEN IFNULL(TEXT, DEF_TXT) ELSE '' END) ES_TEXT
		FROM
			tb_msg_prop
		WHERE USE_YN = 'Y'
		GROUP BY CODE
		ORDER BY CODE ASC
	</select>

	<select id="getMysqlTableSchema" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
		  C.TABLE_SCHEMA,
		  C.TABLE_NAME,
		  (SELECT TABLE_COMMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = #{TABLE_SCHEMA} AND TABLE_NAME = C.TABLE_NAME LIMIT 1) TABLE_COMMENT,
		  C.COLUMN_NAME,
		  CONCAT(C.DATA_TYPE,'(',IFNULL(CHARACTER_MAXIMUM_LENGTH,IFNULL(NUMERIC_PRECISION,'')),')') TYPE,
		  C.IS_NULLABLE,
		  C.COLUMN_COMMENT
		FROM INFORMATION_SCHEMA.COLUMNS C
		WHERE C.TABLE_SCHEMA = #{TABLE_SCHEMA}
		ORDER BY C.TABLE_SCHEMA, C.TABLE_NAME, C.ORDINAL_POSITION
	</select>

	<select id="getProjectImageListForExcel" parameterType="map" resultType="map">
		SELECT
			DATE_FORMAT(CONVERT_TZ(TP.REG_DT, "+0:00", "+9:00"), '%Y-%m-%d-%H:%I') AS REG_DATE, /*DB설정이 UTC(COORDINATED UNIVERSAL TIME)여서 +9해줌*/
			TP.SEQ,
			TPM.TITLE,
			TF.`TYPE`,
			CONCAT(TF.`PATH`, '/', TF.NEW_NAME) as FILE_PATH
		FROM TB_PROJECT TP INNER JOIN TB_PROJECT_ML TPM ON TP.SEQ = TPM.SEQ
								INNER JOIN TB_FILE TF ON TP.SEQ = TF.ATT_SEQ
		WHERE TPM.LANG = 'KO'
		AND TF.ATT_TYPE = 'PROJECT'
		ORDER BY TP.SEQ, TF.TYPE DESC, TF.ATT_ORDER, TF.ORG_NAME
	</select>

	<select id="getProjectListForExcelByLang" parameterType="map" resultType="map">
		SELECT
			CONCAT(DATE_FORMAT(REG_DT, '%Y-%m-%d'), '-00:00') AS REG_DATE,
			M.TITLE,
			M.SUB_TITLE,
			IFNULL((SELECT CASE WHEN #{LANG} = 'EN' THEN TC.EN_TEXT WHEN #{LANG} = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_1), A.TYPE_1) AS TYPE_1,
			IFNULL((SELECT CASE WHEN #{LANG} = 'EN' THEN TC.EN_TEXT WHEN #{LANG} = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_2), A.TYPE_2) AS TYPE_2,
			IFNULL((SELECT CASE WHEN #{LANG} = 'EN' THEN TC.EN_TEXT WHEN #{LANG} = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_3), A.TYPE_3) AS TYPE_3,
			IFNULL((SELECT CASE WHEN #{LANG} = 'EN' THEN TC.EN_TEXT WHEN #{LANG} = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_4), A.TYPE_4) AS TYPE_4,
			IFNULL((SELECT CASE WHEN #{LANG} = 'EN' THEN TC.EN_TEXT WHEN #{LANG} = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_5), A.TYPE_5) AS TYPE_5,
			M.CLIENT,
			A.YEAR,
			(SELECT REPLACE(MAX(TF.`PATH`), #{DEL_DIR}, '') FROM TB_FILE TF WHERE TF.`TYPE` = 'PC' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS PC_IMG_PATH,
			(SELECT GROUP_CONCAT(TF.NEW_NAME SEPARATOR '\r\n') FROM TB_FILE TF WHERE TF.`TYPE` = 'PC' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS PC_IMG_NM,
			(SELECT REPLACE(MAX(TF.`PATH`), #{DEL_DIR}, '') FROM TB_FILE TF WHERE TF.`TYPE` = 'MO' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS MO_IMG_PATH,
			(SELECT GROUP_CONCAT(TF.NEW_NAME SEPARATOR '\r\n') FROM TB_FILE TF WHERE TF.`TYPE` = 'MO' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS MB_IMG_NM,
			M.CONT
		FROM
			(
				SELECT
					L.LANG, P.SEQ, TYPE_1, TYPE_2, TYPE_3, TYPE_4, TYPE_5, `YEAR`, DISP_YN, REG_ID, REG_DT, UPD_ID, UPD_DT
				FROM TB_PROJECT P JOIN  (
										WITH TEMP_LANG AS (SELECT'KO' AS LANG UNION SELECT 'EN' AS LANG UNION SELECT 'ES' AS LANG)
										SELECT LANG FROM TEMP_LANG
									) L
			) A LEFT OUTER JOIN TB_PROJECT_ML M ON A.LANG = M.LANG AND A.SEQ = M.SEQ
		WHERE A.LANG = #{LANG}
		ORDER BY A.SEQ ASC
	</select>
	
	<select id="getProjectListForExcelForCheck" parameterType="map" resultType="map">
		SELECT
			A.SEQ,
			A.LANG,
			CONCAT(DATE_FORMAT(REG_DT, '%Y-%m-%d'), '-00:00') AS REG_DATE,
			A.BUSI_CD,
			M.TITLE,
			(CASE WHEN M.SUB_TITLE IS NULL THEN '' ELSE M.SUB_TITLE END) AS SUB_TITLE,
			IFNULL((SELECT CASE WHEN A.LANG = 'EN' THEN TC.EN_TEXT WHEN A.LANG = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_1), A.TYPE_1) AS TYPE_1,
			IFNULL((SELECT CASE WHEN A.LANG = 'EN' THEN TC.EN_TEXT WHEN A.LANG = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_2), A.TYPE_2) AS TYPE_2,
			IFNULL((SELECT CASE WHEN A.LANG = 'EN' THEN TC.EN_TEXT WHEN A.LANG = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_3), A.TYPE_3) AS TYPE_3,
			IFNULL((SELECT CASE WHEN A.LANG = 'EN' THEN TC.EN_TEXT WHEN A.LANG = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_4), A.TYPE_4) AS TYPE_4,
			IFNULL((SELECT CASE WHEN A.LANG = 'EN' THEN TC.EN_TEXT WHEN A.LANG = 'ES' THEN TC.ES_TEXT ELSE TC.KO_TEXT END FROM TB_CODE TC WHERE TC.CODE = A.TYPE_5), A.TYPE_5) AS TYPE_5,
			M.CLIENT,
			A.YEAR,
			(SELECT REPLACE(MAX(TF.`PATH`), #{DEL_DIR}, '') FROM TB_FILE TF WHERE TF.`TYPE` = 'PC' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS PC_IMG_PATH,
			(SELECT GROUP_CONCAT(TF.NEW_NAME SEPARATOR '\r\n') FROM TB_FILE TF WHERE TF.`TYPE` = 'PC' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS PC_IMG_NM,
			(SELECT REPLACE(MAX(TF.`PATH`), #{DEL_DIR}, '') FROM TB_FILE TF WHERE TF.`TYPE` = 'MO' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS MO_IMG_PATH,
			(SELECT GROUP_CONCAT(TF.NEW_NAME SEPARATOR '\r\n') FROM TB_FILE TF WHERE TF.`TYPE` = 'MO' AND TF.ATT_TYPE = 'PROJECT' AND TF.ATT_SEQ = A.SEQ) AS MB_IMG_NM,
			M.CONT
		FROM
			(
				SELECT
					L.LANG, P.SEQ, TYPE_1, TYPE_2, TYPE_3, TYPE_4, TYPE_5, `YEAR`, DISP_YN, REG_ID, REG_DT, UPD_ID, UPD_DT, P.BUSI_CD
				FROM TB_PROJECT P JOIN  (
										WITH TEMP_LANG AS (SELECT'KO' AS LANG UNION SELECT 'EN' AS LANG UNION SELECT 'ES' AS LANG)
										SELECT LANG FROM TEMP_LANG
									) L
			) A LEFT OUTER JOIN TB_PROJECT_ML M ON A.LANG = M.LANG AND A.SEQ = M.SEQ
		ORDER BY A.REG_DT DESC, A.SEQ ASC, (CASE WHEN A.LANG = 'KO' THEN 1 WHEN A.LANG = 'EN' THEN 2 WHEN A.LANG = 'ES' THEN 3 END) ASC 
	</select>

	<delete id="resetProjectMl">
		DELETE FROM TB_PROJECT_ML
	</delete>

	<delete id="resetProjectMast">
		DELETE FROM TB_PROJECT
	</delete>

	<delete id="resetProjectFile">
		DELETE FROM TB_FILE WHERE ATT_TYPE = 'PROJECT'
	</delete>
</mapper>
